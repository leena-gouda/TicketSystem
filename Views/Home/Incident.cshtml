@model IncidentModel
@{
        var ticket = Model?.Ticket;
    var attachmentName = Model?.Ticket?.AttachmentName ?? "No attachment name";
    var attachmentPath = Model?.Ticket?.AttachmentPath ?? "#";
    var openDate = Model?.openDate != null
        ? Model.openDate.ToString("yyyy-MM-dd")
        : "No date";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />

@Html.Raw(@"<style>
    .custom-scroll {
        width: 100%;
        max-height: 200px;
        overflow: auto;
        border: 1px solid #ccc;
        border-left: 4px solid #1a73e8;
        background-color: #ffffff;
        padding: 1rem;
        border-radius: 0.25rem;
    }
    .custom-scroll::-webkit-scrollbar {
      width: 10px;
    }
    .custom-scroll::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 5px;
    }

    .custom-scroll::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
    .text-welcome {
        color: #1a73e8;
    }

    .btn-blue {
        background-color: #1a73e8;
        color: #fff;
        border: none;
        transition: background-color 0.3s ease;
    }

        .btn-blue:hover {
            background-color: #155ab6;
        }

    .form-label {
        font-weight: 600;
        color: #1a73e8;
    }

    .form-control,
    .form-select {
        border-radius: 0.25rem;
        border-color: #1a73e8;
    }

    .card {
        border: none;
        border-radius: 0.5rem;
        box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }

    .fade-in {
        animation: fadeIn 0.7s ease-in-out;
    }

    @keyframes fadeIn {
        from

    {
        opacity: 0;
        transform: translateY(10px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }

    }

    .form-text.text-muted {
        font-size: 0.875rem;
    }

    .list-group-item {
        border-left: 4px solid #1a73e8;
    }
</style")
<div class="container mt-4 fade-in">
        @* @if (!string.IsNullOrEmpty(Model.Ticket.AttachmentPath))
        {
            <div class="mb-3">
                <label asp-for="Ticket.AttachmentName" class="form-label fw-bold">Manage Attachments</label>
                <label asp-for="Ticket.AttachmentName" class="form-label">
                    <i class="fas fa-file me-2"></i>
                </label>
                <label asp-for="Ticket.AttachmentName" class="form-label">@Model.Ticket.AttachmentName</label>
                <a asp-for="Ticket.AttachmentPath" href="@Url.Content(Model.Ticket.AttachmentPath)" target="_blank" class="form-label">
                    [view]
                </a>
                <label asp-for="openDate" class="form-label">@Model.openDate</label>
                
            </div>
        } *@
        @* @if (!string.IsNullOrEmpty(Model?.Ticket?.AttachmentPath))
        {
            <div class="mb-3">
                <label class="form-label fw-bold">Manage Attachments</label>
                <label class="form-label">
                    <i class="fas fa-file me-2"></i>
                </label>

                <label class="form-label">
                    @Model?.Ticket?.AttachmentName ?? "No attachment name"
                </label>

                <a href="@Url.Content(Model?.Ticket?.AttachmentPath ?? "#")" target="_blank" class="form-label">
                    [view]
                </a>

                <label class="form-label">
                    @Model?.openDate.ToString("yyyy-MM-dd")
                </label>
            </div>
        } *@

        @if (ticket != null && !string.IsNullOrEmpty(attachmentPath))
        {

            <div class="mb-3">
                <label class="form-label fw-bold">Manage Attachments</label>
                <label class="form-label"><i class="fas fa-file me-2"></i></label>
                <label class="form-label">@attachmentName</label>
                <a href="@(string.IsNullOrWhiteSpace(attachmentPath) || attachmentPath == "#" ? "#" : Url.Content(attachmentPath))" target="_blank" class="form-label">[view]</a>
                @* <a href="@Url.Content(attachmentPath)" target="_blank" class="form-label">[view]</a> *@
                <label class="form-label">@openDate</label>
            </div>
        }

        <div class="mb-3">
            <input type="text" id="disabledTextBox" disabled value="You can see this incident and partcipate adding comments as you are a member of the Watch list" class="form-control"/>
        </div>

        <div class="row mb-3 align-items-center">
            <div class="col-md-6">
                <div class="d-flex align-items-center">
                    <label asp-for="Id" class="form-label me-2" style="min-width: 80px;">Number</label>
                    <input asp-for="Id" type="text" disabled value="@Model.Id" class="form-control form-control-sm" style="width: 150px;" />
                </div>
            </div>

            <div class="col-md-6">
                <div class="d-flex align-items-center ">
                    <label asp-for="State" class="form-label me-2" style="min-width: 80px;">State</label>
                    <input asp-for="State" class="form-control form-control-sm" style="width: 150px;" type="text" disabled value="@Model.State" />
                </div>
            </div>
        </div>

        <div class="row mb-3 align-items-center">
            <div class="col-md-6">
                <div class="d-flex align-items-center">
                    <label asp-for="caller.Login.Name" class="form-label me-2" style="min-width: 80px;">Caller</label>
                <input asp-for="caller.Login.Name" type="text" disabled value="@Model.caller.Login.Name" class="form-control form-control-sm" style="width: 150px;" />
                </div>
            </div>

            <div class="col-md-6">
                <div class="d-flex align-items-center ">
                    <label asp-for="openDate" class="form-label me-2" style="min-width: 80px;">opened</label>
                    <input asp-for="openDate" class="form-control form-control-sm" style="width: 150px;" type="text" disabled value="@Model.openDate" /><br />
                </div>
            </div>
        </div>

        
        <div class="row mb-3 align-items-start">
            <div class="col-md-6">
                <div class="d-flex align-items-center">
                    <label asp-for="Ticket.ServiceType" class="form-label me-2" style="min-width: 80px;">Service</label>
                    <input asp-for="Ticket.ServiceType" class="form-control form-control-sm" style="width: 150px; type="text" disabled value="@Model.Ticket.ServiceType" />
                </div>
            </div>

            <div class="col-md-6">
                <div class="d-flex align-items-center ">
                    <label asp-for="closedDate" class="form-label me-2" style="min-width: 80px;">Closed</label>
                    <input asp-for="closedDate" type="text" class="form-control form-control-sm" style="width: 150px;" disabled value="@Model.closedDate" />
                </div>
            </div>
        </div>
        

        <div class="mb-3">
            <div class="d-flex align-items-center ">
                <label asp-for="Ticket.Impact" class="form-label me-2" style="min-width: 80px;">Priority</label>
                <input asp-for="Ticket.Impact" class="form-control form-control-sm" style="width: 150px;" type="text" disabled value="@Model.Ticket.Impact" /><br />
            </div>
        </div>

        <div class="mb-3">
                <label asp-for="Ticket.ShortDescription" class="form-label" >Short description</label>
                <input asp-for="Ticket.ShortDescription" class="form-control"  type="text" disabled value="@Model.Ticket.ShortDescription" /><br />
        </div>

        <div class="mb-3">
                <label asp-for="Ticket.Description" class="form-label" style="min-width: 80px;">Description</label>
                <input asp-for="Ticket.Description" class="form-control" type="text" disabled value="@Model.Ticket.Description" /><br />
        </div>

        <div class="mb-3">
            @if (Model?.Ticket?.TicketWatchers?.Any() == true)
            {
                <label asp-for="Ticket.TicketWatchers" class="form-label">Watch list</label>
                <label asp-for="Ticket.TicketWatchers" class="form-label">
                    <i class="fas fa-lock me-2"></i>
                </label>
                <ul class="list-group">
                @foreach (var watcher in Model.Ticket.TicketWatchers)
                    {
                        var login = watcher?.Watcher?.Login;
                        <li class="list-group-item">
                        <strong>@login?.Name </strong> - @login?.Role (<em>@login?.Email </em>)
                        </li>
                    }
                </ul>
            }
            
        </div>
    <div class="card p-4 mb-4">
        <form asp-controller="Home" asp-action="Incident" method="post">
            <input type="hidden" name="id" value="@Model.Id" />
            <div class="mb-3">
                <label asp-for="AdditionalComments" class="form-label">Additional comments (caller visible) </label>
                <textarea asp-for="AdditionalComments" name="AdditionalComments" class="form-control" rows="4" maxlength="4000" placeholder="Enter your comment" id="commentBox"></textarea>
                <small id="charCounter" class="form-text text-muted">4000 characters remaining</small>
            </div>
        </form>
    </div>
        @section Scripts {
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script>
                 document.addEventListener("DOMContentLoaded", function () {
                    const commentBox = document.getElementById("commentBox");
                    const charCounter = document.getElementById("charCounter");
                    const maxLength = 4000;

                    if (!commentBox || !charCounter) {
                        console.warn("Comment box or counter not found.");
                        return;
                    }
                commentBox.addEventListener("input", () => {
                    const remaining = maxLength - commentBox.value.length;
                    charCounter.textContent = `${remaining} characters remaining`;
                });
                commentBox.addEventListener("keydown", function(event) {
                    if (event.key === "Enter" && !event.shiftKey) {
                        event.preventDefault();
                        if (commentBox.value.trim() !== "") {
                            // commentBox.closest("form").submit();
                        submitCommentAjax();
                        }
                    }
                });

                           function submitCommentAjax() {
                const form = commentBox.closest("form");
                          if (!form) return;
                $.ajax({
                    url: form.action,
                    method: "POST",
                    data: $(form).serialize(),
                    headers: { "X-Requested-With": "XMLHttpRequest" },
                    success: function (partialHtml) {
                        $('#commentsContainer').html(partialHtml);
                        commentBox.value = "";
                        charCounter.textContent = "4000 characters remaining";
                    },
                    error: function () {
                        alert("Failed to submit comment.");
                    }
                });
            }
          });
            

            </script>
        }

    <div id="commentsContainer">
        @await Html.PartialAsync("PreviousCommentsPartial", Model)
    </div>

    <div class="text-center mt-4 mb-5">
      <a href="@Url.Action("Dashboard", "Home")" class="btn btn-blue rounded-pill px-4">
        <i class="fas fa-tachometer-alt me-2"></i> Go to Dashboard
      </a>
    </div>


        @* <div class="mb-3">
            <label asp-for="previousComments" class="form-label">Previous comments</label>
            <div class="row">
                <label asp-for="previousComments" class="form-label"> #@Model.closedDate - #@Model.Watcher.Name</label>
                <label asp-for="previousComments" class="form-label"> Additional comments (caller visible) </label>
                <label asp-for="previousComments" class="form-label"> #@Model.AdditionalComments</label>
            </div>
        </div> *@

    @* <div class="mb-4" id="commentsContainer">
            <label class="form-label">Previous Comments</label>
            <div class="custom-scroll"> 
                @if (Model.previousComments != null && Model.previousComments.Any())
                {
                    foreach (var comment in Model.previousComments)
                    {
                        <div class="border-bottom pb-2 mb-3">
                        <small class="text-muted">@comment.ClosedTime - @comment.Login.Email</small>
                            <p class="mb-1">@comment.CommentText</p>
                        </div>
                    }
                }
                else
                {
                    <p class="text-muted">No comments yet.</p>
                }

            </div>
        </div> *@

    </div>
